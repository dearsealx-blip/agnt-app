<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#060a14">
<title>AGNT</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@tonconnect/ui@2.0.9/dist/tonconnect-ui.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#060a14;--bg2:rgba(14,24,44,0.7);--bg3:rgba(14,24,44,0.4);
  --g:#00e8b8;--gg:rgba(0,232,184,0.15);--gd:rgba(0,232,184,0.06);
  --p:#b794f6;--b:#63b3ed;--r:#f87171;--o:#fbbf24;
  --t:#e2e8f2;--t2:#8a9bb8;--t3:#4d6380;
  --card:rgba(14,24,44,0.6);--bdr:rgba(255,255,255,0.06);--bdr2:rgba(255,255,255,0.1);
  --blur:blur(20px);
  --sans:'DM Sans',sans-serif;--mono:'DM Mono',monospace
}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--t);font-family:var(--sans);-webkit-font-smoothing:antialiased}

/* === LAYOUT === */
.app{height:100%;display:flex;flex-direction:column}
.head{padding:10px 16px;display:flex;align-items:center;justify-content:space-between;background:rgba(6,10,20,0.9);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-bottom:1px solid var(--bdr);z-index:10}
.logo{display:flex;align-items:center;gap:7px}
.mark{width:28px;height:28px;border-radius:9px;background:linear-gradient(135deg,var(--g),#009e7a);display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:12px;font-weight:800;color:#000;box-shadow:0 0 12px rgba(0,232,184,0.2)}
.logo span{font-weight:800;font-size:15px}
.wallet-btn{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:600;border:1px solid var(--bdr2);color:var(--t2);background:var(--bg2);cursor:pointer;transition:.15s}
.wallet-btn:active{transform:scale(.96)}
.wallet-btn.on{border-color:rgba(0,232,184,0.2);color:var(--g);background:var(--gd)}

.content{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
.nav{display:flex;background:rgba(6,10,20,0.95);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-top:1px solid var(--bdr);padding:6px 0 env(safe-area-inset-bottom,8px)}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 0;font-size:9px;color:var(--t3);cursor:pointer;transition:.15s;-webkit-user-select:none}
.ni.on{color:var(--g)}.ni.on .ni-ic{transform:scale(1.05)}
.ni-ic{font-size:18px;transition:.15s}

/* === PAGES === */
.pg{display:none;min-height:100%}.pg.on{display:block}

/* === HOME === */
.hero-price{text-align:center;padding:28px 20px 20px;position:relative}
.hero-price::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:300px;height:200px;background:radial-gradient(ellipse,rgba(0,232,184,0.04) 0%,transparent 70%);pointer-events:none}
.price-main{font-family:var(--mono);font-size:42px;font-weight:800;color:var(--g);letter-spacing:-1px}
.price-change{font-size:14px;font-weight:600;margin-top:2px}
.price-change.up{color:var(--g)}.price-change.down{color:var(--r)}
.price-label{font-size:11px;color:var(--t3);margin-top:6px}
.price-sub{display:flex;justify-content:center;gap:16px;margin-top:10px}
.price-sub-item{font-size:11px;color:var(--t3);font-family:var(--mono)}
.price-sub-item b{color:var(--t2)}
.price-loading{font-family:var(--mono);font-size:42px;font-weight:800;color:var(--t3);letter-spacing:-1px}

.ask-bar{margin:0 16px 16px;display:flex;gap:8px;cursor:pointer}
.ask-input{flex:1;padding:13px 16px;background:var(--card);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid var(--bdr2);border-radius:16px;font-size:13px;color:var(--t2);transition:.15s}
.ask-input:active{border-color:rgba(0,232,184,0.15)}
.ask-send{width:46px;height:46px;border-radius:14px;background:linear-gradient(135deg,var(--g),#009e7a);display:flex;align-items:center;justify-content:center;font-size:18px;color:#000;flex-shrink:0;box-shadow:0 4px 16px rgba(0,232,184,0.2)}

.sec{display:flex;justify-content:space-between;align-items:center;padding:4px 16px;margin:14px 0 8px}
.sec-t{font-size:13px;font-weight:700}.sec-a{font-size:11px;color:var(--g);cursor:pointer}

.quick-scroll{display:flex;gap:8px;padding:0 16px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.quick-scroll::-webkit-scrollbar{display:none}
.qp{flex-shrink:0;padding:10px 16px;border-radius:12px;background:var(--card);border:1px solid var(--bdr);font-size:12px;color:var(--t2);cursor:pointer;transition:.15s;max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.qp:active{transform:scale(.96);border-color:rgba(0,232,184,0.15)}

.agent-card{margin:0 16px 10px;background:var(--card);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid var(--bdr);border-radius:16px;padding:14px;cursor:pointer;transition:.15s;position:relative;overflow:hidden}
.agent-card:active{transform:scale(.98)}
.agent-card-top{position:absolute;top:0;left:0;right:0;height:2px}
.agent-row{display:flex;align-items:center;gap:12px}
.agent-av{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.agent-body{flex:1;min-width:0}
.agent-name{font-size:14px;font-weight:700}
.agent-desc{font-size:11px;color:var(--t3);margin-top:1px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.agent-meta{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.agent-pill{font-size:9px;padding:2px 7px;border-radius:5px;font-weight:600}

/* === CHAT === */
.chat-panel{position:fixed;inset:0;background:var(--bg);z-index:50;display:none;flex-direction:column}
.chat-panel.on{display:flex}
.cp-top{padding:10px 12px;display:flex;align-items:center;gap:10px;background:rgba(6,10,20,0.95);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-bottom:1px solid var(--bdr)}
.cp-back{width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;border-radius:8px}
.cp-back:active{background:var(--bg3)}
.cp-av{width:36px;height:36px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px}
.cp-nm{font-size:14px;font-weight:700}
.cp-st{font-size:10px;color:var(--g);display:flex;align-items:center;gap:3px}
.cp-st::before{content:'';width:4px;height:4px;border-radius:50%;background:var(--g)}
.cp-nm.thinking .cp-st::before{background:var(--o);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.cp-ms{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:6px}
.msg{max-width:85%;padding:10px 14px;border-radius:14px;font-size:12.5px;line-height:1.55;animation:msgIn .3s ease both}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}}
.msg.u{background:linear-gradient(135deg,var(--g),#009e7a);color:#000;align-self:flex-end;border-bottom-right-radius:4px;font-weight:500}
.msg.a{background:var(--bg2);border:1px solid var(--bdr);align-self:flex-start;border-bottom-left-radius:4px}
.msg.a .ai-badge{display:inline-flex;align-items:center;gap:3px;font-size:8px;color:var(--b);background:rgba(99,179,237,0.08);padding:2px 6px;border-radius:3px;margin-bottom:4px}
.msg.s{align-self:center;color:var(--t3);font-size:10px;padding:4px 8px;background:none;animation:none}
.msg pre{background:var(--bg);padding:8px 10px;border-radius:8px;border:1px solid var(--bdr);font-family:var(--mono);font-size:11px;line-height:1.5;margin:4px 0;white-space:pre-wrap;overflow-x:auto}
.msg code{background:var(--bg);padding:1px 4px;border-radius:3px;font-family:var(--mono);font-size:11px}
.msg a{color:var(--b);word-break:break-all}
.msg .act{margin:8px 0;background:var(--bg3);border:1px solid var(--bdr);border-radius:12px;padding:12px}
.msg .act-t{font-size:12px;font-weight:600;margin-bottom:6px}
.msg .act-d{font-size:10px;color:var(--t3);margin-bottom:8px}
.msg .act-btns{display:flex;gap:6px}
.msg .act-y{padding:7px 16px;border-radius:8px;background:var(--g);color:#000;border:none;font-weight:600;font-size:11px;cursor:pointer;font-family:var(--sans)}
.msg .act-n{padding:7px 16px;border-radius:8px;background:var(--bg2);color:var(--t3);border:1px solid var(--bdr);font-weight:600;font-size:11px;cursor:pointer;font-family:var(--sans)}
.cp-in{padding:8px 12px;background:rgba(6,10,20,0.95);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border-top:1px solid var(--bdr);display:flex;gap:8px;align-items:flex-end}
.cp-in input{flex:1;padding:11px 14px;background:var(--bg2);border:1px solid var(--bdr);border-radius:14px;color:var(--t);font-size:13px;outline:none;font-family:var(--sans)}
.cp-in input::placeholder{color:var(--t3)}
.cp-in input:focus{border-color:rgba(0,232,184,0.2)}
.cp-in button{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--g),#009e7a);border:none;color:#000;font-size:16px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.cp-in button:active{transform:scale(.93)}

/* === CREATE === */
.create-hero{text-align:center;padding:28px 20px 16px}
.create-hero h2{font-size:20px;font-weight:800;margin-bottom:4px}
.create-hero p{font-size:12px;color:var(--t2)}
.tmpl-grid{padding:0 16px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
.tmpl{background:var(--card);border:1px solid var(--bdr);border-radius:14px;padding:14px;cursor:pointer;text-align:center;transition:.15s;position:relative;overflow:hidden}
.tmpl:active{transform:scale(.96)}
.tmpl-ic{font-size:28px;margin-bottom:6px}
.tmpl-nm{font-size:12px;font-weight:700;margin-bottom:2px}
.tmpl-ds{font-size:9px;color:var(--t3);line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

.form-group{padding:0 16px;margin-bottom:10px}
.form-group label{display:block;font-size:11px;color:var(--t3);font-weight:600;margin-bottom:4px}
.fi{width:100%;padding:11px 14px;background:var(--bg2);border:1px solid var(--bdr);border-radius:12px;color:var(--t);font-size:13px;font-family:var(--sans);outline:none;resize:none}
.fi:focus{border-color:rgba(0,232,184,0.2)}
.fi-area{min-height:80px}
.tool-toggle{display:flex;gap:8px;padding:0 16px;margin-bottom:12px}
.tt{flex:1;padding:10px;border-radius:10px;text-align:center;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--bdr);color:var(--t3);transition:.15s}
.tt.on{background:var(--gd);border-color:rgba(0,232,184,0.15);color:var(--g)}
.tt:active{transform:scale(.96)}

.btn{display:block;width:100%;padding:13px;border-radius:14px;border:none;font-weight:700;font-size:14px;cursor:pointer;font-family:var(--sans);transition:.15s}
.btn:active{transform:scale(.97)}
.btn-g{background:linear-gradient(135deg,var(--g),#009e7a);color:#000;box-shadow:0 4px 16px rgba(0,232,184,0.2)}
.btn-s{background:var(--bg2);color:var(--t2);border:1px solid var(--bdr)}

/* === AGENTS LIST === */

/* === PROFILE === */
.profile{text-align:center;padding:32px 20px}
.profile-av{width:60px;height:60px;border-radius:18px;background:linear-gradient(135deg,var(--g),#009e7a);margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800;color:#000;font-family:var(--mono)}
.profile-name{font-size:18px;font-weight:800}
.profile-addr{font-size:11px;color:var(--t3);font-family:var(--mono);margin-top:2px;cursor:pointer}
.profile-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:20px 16px}
.ps{text-align:center;background:var(--bg2);border:1px solid var(--bdr);border-radius:14px;padding:14px}
.ps-v{font-family:var(--mono);font-size:20px;font-weight:700}
.ps-l{font-size:9px;color:var(--t3);margin-top:2px}

/* === TOAST === */
.toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-60px);padding:10px 20px;border-radius:12px;background:rgba(14,24,44,0.95);backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid var(--bdr);font-size:12px;font-weight:600;z-index:200;transition:.3s;pointer-events:none}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.err{border-color:rgba(248,113,113,0.2);color:var(--r)}

/* === ANIMATIONS === */
.afu{opacity:0;transform:translateY(12px);animation:fadeUp .4s ease both}
@keyframes fadeUp{to{opacity:1;transform:none}}

/* === MODAL === */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:100;display:none;align-items:flex-end;justify-content:center}
.modal-bg.on{display:flex}
.modal{width:100%;max-width:420px;background:var(--bg);border-top-left-radius:20px;border-top-right-radius:20px;padding:20px;max-height:80vh;overflow-y:auto}
.modal h3{font-size:16px;font-weight:700;margin-bottom:4px}
.modal-close{position:absolute;top:16px;right:16px;font-size:18px;color:var(--t3);cursor:pointer}
</style>
</head>
<body>
<div class="app">
  <div class="head">
    <div class="logo"><div class="mark">A</div><span>AGNT</span></div>
    <div class="wallet-btn" id="walletBtn" onclick="handleWallet()">Connect</div>
  </div>

  <div class="content">
    <div class="pg on" id="pg0">
      <div class="hero-price">
        <div class="price-loading" id="priceMain">‚Äî</div>
        <div class="price-change" id="priceChange"></div>
        <div class="price-label">TON ¬∑ Live from CoinGecko</div>
        <div class="price-sub">
          <span class="price-sub-item" id="pBtc"></span>
          <span class="price-sub-item" id="pEth"></span>
        </div>
      </div>

      <div class="ask-bar" onclick="openChat(AGNT)">
        <div class="ask-input">Ask AGNT anything about TON...</div>
        <div class="ask-send">‚Üë</div>
      </div>

      <div class="quick-scroll" id="quickPrompts"></div>
      <div id="homeAgents"></div>
    </div>

    <div class="pg" id="pg1"></div>
    <div class="pg" id="pg2"></div>
    <div class="pg" id="pg3"></div>
  </div>

  <div class="nav">
    <div class="ni on" onclick="go(0)"><span class="ni-ic">üè†</span>Home</div>
    <div class="ni" onclick="go(1)"><span class="ni-ic">‚ú®</span>Create</div>
    <div class="ni" onclick="go(2)"><span class="ni-ic">ü§ñ</span>Agents</div>
    <div class="ni" onclick="go(3)"><span class="ni-ic">üë§</span>Profile</div>
  </div>
</div>

<div class="chat-panel" id="chatPanel">
  <div class="cp-top">
    <div class="cp-back" onclick="closeChat()">‚Üê</div>
    <div class="cp-av" id="cpAv">ü§ñ</div>
    <div style="flex:1"><div class="cp-nm" id="cpNm">AGNT<div class="cp-st">Online ¬∑ AI</div></div></div>
  </div>
  <div class="cp-ms" id="cpMs"></div>
  <div class="cp-in"><input id="cpIn" placeholder="Type a message..." onkeydown="if(event.key==='Enter')send()"><button onclick="send()">‚Üë</button></div>
</div>

<div class="modal-bg" id="modalBg" onclick="closeModal()"><div class="modal" id="modal" onclick="event.stopPropagation()"></div></div>
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê
var PROXY='https://evanwang-agntproxy.web.val.run';
var BACKEND='https://agnt-app-production.up.railway.app'; // Set to backend URL when deployed
var OWNER='UQAbpN74Kp_u9YFygTTKsl0MFO4atpyCKC0C7awTRRxspE6G';

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
var MKT={tp:0,tc:0,bp:0,ep:0,mcap:0,vol:0,ts:0};
var W={addr:'',ui:null,bal:0};
var tab=0,curAgent=null,sending=false;
var agents=[];var chats={};var MEM={};

var AGNT={
  id:'agnt',name:'AGNT',icon:'ü§ñ',color:'#00e8b8',
  desc:'Real AI with live market data, wallet access, and on-chain intelligence.',
  prompt:`You are AGNT, the core AI of the AGNT platform on TON blockchain.

You have REAL tools ‚Äî live price data, wallet balances (including tokens and NFTs), on-chain data, and STON.fi DEX prices are injected into your context before every response. Use this REAL data. Never make up numbers. Never say "I don't have access to real-time data" ‚Äî you DO.

Roles:
1. ANALYST ‚Äî Market analysis using the live data in your context. Give specific numbers. Be direct.
2. ASSISTANT ‚Äî Help with TON DeFi, staking, NFTs, bridging. Be practical and specific.
3. BUILDER ‚Äî When user wants to create an agent, ask: purpose, personality, tools needed, price. Then output:
\\\`\\\`\\\`agentconfig
{"name":"...","icon":"emoji","desc":"...","prompt":"...","tools":{"prices":true,"wallet":false,"tonapi":false},"price":0.01}
\\\`\\\`\\\`

Be concise. Use real numbers from context. No filler. Just help.`,
  tools:{prices:true,wallet:true,tonapi:true},price:0,queries:0
};

// ‚ïê‚ïê‚ïê AGENT TEMPLATES ‚ïê‚ïê‚ïê
var TEMPLATES=[
  {name:'Whale Watcher',icon:'üêã',color:'#06b6d4',desc:'Tracks large TON transactions and whale movements',
    prompt:'You are Whale Watcher. Analyze large TON transactions using on-chain data. Flag movements >10K TON. Rate impact: üü¢low üü°medium üî¥high. Use real numbers from context. Be direct.',
    tools:{prices:true,wallet:false,tonapi:true},price:0.02},
  {name:'Yield Finder',icon:'üßô',color:'#b794f6',desc:'Finds best DeFi yields across TON protocols',
    prompt:'You are Yield Finder. Compare DeFi yields on TON: STON.fi, DeDust, Tonstakers, Bemo, EVAA. For each: name, APY, risk level, IL risk. Use real price data. Show math. Never recommend >30% in one pool.',
    tools:{prices:true,wallet:true,tonapi:false},price:0.01},
  {name:'Rug Detector',icon:'üîç',color:'#f87171',desc:'Analyzes token safety with 8-point checklist',
    prompt:'You are Rug Detector. Score tokens 0-8: liquidity lock, ownership, dev %, holders, mint functions, tax, community, DEX listing. 7-8:üü¢ 4-6:üü° 0-3:üî¥. Never say "safe". Say "passes X/8". End with DYOR.',
    tools:{prices:true,wallet:false,tonapi:true},price:0.01},
  {name:'Portfolio Coach',icon:'üìä',color:'#a3e635',desc:'Personalized advice based on your actual wallet',
    prompt:'You are Portfolio Coach. Analyze the user wallet data in your context. Show allocation %, risk assessment, rebalancing suggestions. Compare to conservative/balanced/aggressive targets. Use real numbers only.',
    tools:{prices:true,wallet:true,tonapi:false},price:0.02}
];

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
function $(id){return document.getElementById(id);}
function toast(msg,err){var t=$('toast');t.textContent=msg;t.className='toast'+(err?' err':'')+' show';setTimeout(function(){t.className='toast';},2500);}
function haptic(s){try{window.Telegram?.WebApp?.HapticFeedback?.impactOccurred(s);}catch(e){}}
function save(){try{localStorage.setItem('agnt',JSON.stringify({a:agents,c:chats,m:MEM}));}catch(e){}}
function load(){try{var d=JSON.parse(localStorage.getItem('agnt'));if(d){agents=d.a||[];chats=d.c||{};MEM=d.m||{};}}catch(e){}}

// ‚ïê‚ïê‚ïê WALLET ‚ïê‚ïê‚ïê
function initWallet(){
  try{
    W.ui=new TON_CONNECT_UI.TonConnectUI({manifestUrl:location.origin+'/tonconnect-manifest.json'});
    W.ui.onStatusChange(function(w){
      if(w){W.addr=w.account.address;$('walletBtn').textContent=W.addr.slice(0,4)+'...'+W.addr.slice(-4);$('walletBtn').classList.add('on');}
      else{W.addr='';$('walletBtn').textContent='Connect';$('walletBtn').classList.remove('on');}
      renderProfile();
    });
  }catch(e){}
}
function handleWallet(){if(W.addr&&W.ui){W.ui.disconnect();}else if(W.ui){W.ui.openModal();}}

// ‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê
function go(i){
  tab=i;
  document.querySelectorAll('.pg').forEach(function(p,j){p.classList.toggle('on',j===i);});
  document.querySelectorAll('.ni').forEach(function(n,j){n.classList.toggle('on',j===i);});
  if(i===0)renderHome();else if(i===1)renderCreate();else if(i===2)renderAgents();else if(i===3)renderProfile();
  haptic('light');
}

// ‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê
async function fetchPrices(){
  for(var attempt=0;attempt<3;attempt++){
    try{
      var r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network,bitcoin,ethereum&vs_currencies=usd&include_24hr_change=true&include_market_cap=true&include_24hr_vol=true');
      if(!r.ok){if(attempt<2){await new Promise(function(ok){setTimeout(ok,1500);});continue;}break;}
      var d=await r.json();var t=d['the-open-network'];
      if(t){MKT.tp=t.usd;MKT.tc=t.usd_24h_change||0;MKT.mcap=t.usd_market_cap||0;MKT.vol=t.usd_24h_vol||0;}
      if(d.bitcoin)MKT.bp=d.bitcoin.usd;if(d.ethereum)MKT.ep=d.ethereum.usd;MKT.ts=Date.now();
      try{localStorage.setItem('agnt_mkt',JSON.stringify(MKT));}catch(e2){}
      return;
    }catch(e){if(attempt<2){await new Promise(function(ok){setTimeout(ok,1500);});}}
  }
  try{var c=JSON.parse(localStorage.getItem('agnt_mkt'));if(c&&c.tp){Object.assign(MKT,c);}}catch(e3){}
}

async function getToolContext(ag){
  var ctx=[];
  if(ag.tools.prices){
    if(!MKT.tp||Date.now()-MKT.ts>30000)await fetchPrices();
    if(MKT.tp){ctx.push('[LIVE MARKET] TON: $'+MKT.tp.toFixed(3)+' ('+(MKT.tc>=0?'+':'')+MKT.tc.toFixed(1)+'% 24h) | MCap: $'+(MKT.mcap/1e9).toFixed(2)+'B | Vol: $'+(MKT.vol/1e6).toFixed(1)+'M | BTC: $'+MKT.bp.toFixed(0)+' | ETH: $'+MKT.ep.toFixed(0));}
  }
  if(ag.tools.wallet&&W.addr){
    try{
      var br=await fetch('https://tonapi.io/v2/accounts/'+W.addr);var bd=await br.json();
      var bal=bd.balance?parseInt(bd.balance)/1e9:0;W.bal=bal;
      var jr=await fetch('https://tonapi.io/v2/accounts/'+W.addr+'/jettons').then(function(r2){return r2.json();}).catch(function(){return{balances:[]};});
      var tokens=(jr.balances||[]).slice(0,8).map(function(b){var s=b.jetton&&b.jetton.symbol||'?';var dc=b.jetton&&b.jetton.decimals||9;return{s:s,b:(parseInt(b.balance)/Math.pow(10,dc)).toFixed(2)};}).filter(function(t2){return t2.s!=='?';});
      var wCtx='[WALLET] '+W.addr.slice(0,6)+'...'+W.addr.slice(-4)+' | '+bal.toFixed(2)+' TON ($'+(bal*MKT.tp).toFixed(2)+')';
      if(tokens.length)wCtx+=' | '+tokens.map(function(t2){return t2.s+': '+t2.b;}).join(', ');
      ctx.push(wCtx);
    }catch(e){}
  }
  if(ag.tools.tonapi){
    try{var cr=await fetch('https://tonapi.io/v2/blockchain/masterchain-head');var cd=await cr.json();ctx.push('[CHAIN] Block #'+(cd.seqno||'?')+' | Status: operational');}catch(e){}
  }
  ctx.push('[TIME] '+new Date().toLocaleString());
  return ctx.join('\n');
}

// ‚ïê‚ïê‚ïê AI ‚ïê‚ïê‚ïê
async function callAI(sys,msg,ctx){
  if(BACKEND){
    try{
      var r=await fetch(BACKEND+'/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({agent_id:curAgent?curAgent.id:'agnt_core',message:msg,wallet_address:W.addr})});
      var d=await r.json();if(d.text)return d.text;
    }catch(e){}
  }
  for(var attempt=0;attempt<2;attempt++){
    try{
      var c=new AbortController();var t=setTimeout(function(){c.abort();},20000);
      var r2=await fetch(PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:sys+'\n\n'+ctx,message:msg}),signal:c.signal});
      clearTimeout(t);
      if(r2.ok){var d2=await r2.json();if(d2.choices&&d2.choices[0])return d2.choices[0].message.content;if(d2.content)return typeof d2.content==='string'?d2.content:d2.content[0]&&d2.content[0].text||null;}
    }catch(e){if(attempt<1)await new Promise(function(ok){setTimeout(ok,2000);});}
  }
  return null;
}

// ‚ïê‚ïê‚ïê CHAT ‚ïê‚ïê‚ïê
function openChat(ag){
  curAgent=ag;
  $('cpAv').textContent=ag.icon;$('cpAv').style.background=(ag.color||'var(--g)')+'22';
  $('cpNm').innerHTML=ag.name+'<div class="cp-st">Online ¬∑ AI</div>';
  if(!chats[ag.id])chats[ag.id]=[];
  $('chatPanel').classList.add('on');
  renderMsgs();
  setTimeout(function(){$('cpIn').focus();},300);
  haptic('medium');
}
function closeChat(){$('chatPanel').classList.remove('on');save();}

function renderMsgs(){
  var el=$('cpMs');var msgs=chats[curAgent.id]||[];
  var h='';
  if(!msgs.length)h='<div class="msg s">Ask '+curAgent.name+' anything</div>';
  msgs.forEach(function(m){
    if(m.role==='user')h+='<div class="msg u">'+esc(m.text)+'</div>';
    else{
      h+='<div class="msg a">';
      if(m.tools&&m.tools.length)h+=m.tools.map(function(t){return '<span class="ai-badge">‚úÖ '+t+'</span>';}).join(' ')+'<br>';
      h+=formatResponse(m.text)+'</div>';
    }
  });
  h+='<div id="_typ" style="display:none"><div class="msg a" style="padding:8px 14px"><span style="display:inline-flex;gap:3px"><span style="width:4px;height:4px;border-radius:50%;background:var(--g);animation:pulse 1.4s infinite"></span><span style="width:4px;height:4px;border-radius:50%;background:var(--g);animation:pulse 1.4s .2s infinite"></span><span style="width:4px;height:4px;border-radius:50%;background:var(--g);animation:pulse 1.4s .4s infinite"></span></span></div></div>';
  el.innerHTML=h;el.scrollTop=el.scrollHeight;
}

async function send(){
  if(sending)return;
  var input=$('cpIn');var msg=input.value.trim();if(!msg)return;
  input.value='';sending=true;
  chats[curAgent.id]=chats[curAgent.id]||[];
  chats[curAgent.id].push({role:'user',text:msg});
  renderMsgs();
  $('_typ').style.display='block';
  $('cpMs').scrollTop=$('cpMs').scrollHeight;
  $('cpNm').innerHTML=curAgent.name+'<div class="cp-st" style="color:var(--o)">Thinking...</div>';

  var tools=[];
  if(curAgent.tools.prices)tools.push('Live Prices');
  if(curAgent.tools.wallet&&W.addr)tools.push('Wallet');
  if(curAgent.tools.tonapi)tools.push('Chain Data');

  var ctx=await getToolContext(curAgent);
  var mem=MEM[curAgent.id];if(mem&&mem.length)ctx+='\n[MEMORY] '+mem.join('; ');

  var resp=await callAI(curAgent.prompt,msg,ctx);
  $('_typ').style.display='none';
  $('cpNm').innerHTML=curAgent.name+'<div class="cp-st">Online ¬∑ AI</div>';

  if(resp){
    chats[curAgent.id].push({role:'assistant',text:resp,tools:tools});
    // Memory extraction
    var memKw=['portfolio','hold','invest','bought','sold','prefer','risk','goal','watch','strategy'];
    if(memKw.some(function(k){return msg.toLowerCase().includes(k);})){
      MEM[curAgent.id]=MEM[curAgent.id]||[];MEM[curAgent.id].push(msg.slice(0,100));
      if(MEM[curAgent.id].length>8)MEM[curAgent.id]=MEM[curAgent.id].slice(-8);
    }
    // Agent config detection
    detectAgentConfig(resp);
    curAgent.queries=(curAgent.queries||0)+1;
  }else{
    chats[curAgent.id].push({role:'assistant',text:'Sorry, I couldn\'t connect right now. Try again in a moment.',tools:[]});
  }
  renderMsgs();save();sending=false;
}

function formatResponse(text){
  return text
    .replace(/```agentconfig[\s\S]*?```/g,function(m){var cfg=extractConfig(m);return '<div class="act"><div class="act-t">ü§ñ '+((cfg&&cfg.name)||'Agent')+' Ready</div><div class="act-d">Deploy this agent to your collection</div><div class="act-btns"><button class="act-y" onclick="deployDetected()">Deploy</button><button class="act-n" onclick="this.closest(\'.act\').style.opacity=0.3">Skip</button></div></div>';})
    .replace(/```(\w+)?\n?([\s\S]*?)```/g,'<pre>$2</pre>')
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
    .replace(/^\s*[-‚Ä¢]\s+(.+)$/gm,'<div style="padding-left:12px;margin:2px 0"><span style="color:var(--g)">‚Ä¢</span> $1</div>')
    .replace(/^\s*(\d+)\.\s+(.+)$/gm,'<div style="padding-left:14px;margin:2px 0"><span style="color:var(--g);font-weight:600">$1.</span> $2</div>')
    .replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank">$1</a>')
    .replace(/(\$[\d,.]+)/g,'<span style="color:var(--g);font-family:var(--mono);font-weight:600">$1</span>')
    .replace(/([+-]?\d+\.?\d*%)/g,function(m2){var n=parseFloat(m2);return '<span style="color:'+(n>=0?'var(--g)':'var(--r)')+';font-weight:600">'+m2+'</span>';})
    .replace(/\n/g,'<br>');
}
function esc(s){return s.replace(/</g,'&lt;').replace(/>/g,'&gt;');}

var lastConfig=null;
function extractConfig(text){
  var m=text.match(/```agentconfig\s*\n?([\s\S]*?)```/);
  if(!m)return null;
  try{lastConfig=JSON.parse(m[1].trim());return lastConfig;}catch(e){return null;}
}
function detectAgentConfig(text){
  var cfg=extractConfig(text);
  if(cfg)lastConfig=cfg;
}
function deployDetected(){
  if(!lastConfig)return;
  var ag={id:'ag_'+Date.now(),name:lastConfig.name||'Agent',icon:lastConfig.icon||'ü§ñ',color:lastConfig.color||'#63b3ed',desc:lastConfig.desc||lastConfig.description||'',prompt:lastConfig.prompt||'You are a helpful AI.',tools:lastConfig.tools||{prices:true},price:lastConfig.price||0.01,queries:0};
  agents.push(ag);save();
  toast('üöÄ '+ag.name+' deployed!');haptic('medium');
}

// ‚ïê‚ïê‚ïê SHARING ‚ïê‚ïê‚ïê
function shareAgent(idx){
  var ag=agents[idx];if(!ag)return;
  var data={n:ag.name,i:ag.icon,d:ag.desc,p:ag.prompt,t:ag.tools,pr:ag.price};
  var encoded=btoa(unescape(encodeURIComponent(JSON.stringify(data))));
  var link='https://t.me/agnt_bot?startapp='+encoded;
  navigator.clipboard.writeText(link).then(function(){toast('üìã Link copied!');}).catch(function(){toast(link);});
  haptic('medium');
}

// ‚ïê‚ïê‚ïê RENDER: HOME ‚ïê‚ïê‚ïê
function askQuick(text){openChat(AGNT);setTimeout(function(){document.getElementById("cpIn").value=text;send();},300);}
function renderHome(){
  // Price display
  if(MKT.tp){
    $('priceMain').textContent='$'+MKT.tp.toFixed(3);$('priceMain').className='price-main';
    var arrow=MKT.tc>=0?'‚ñ≤':'‚ñº';$('priceChange').textContent=arrow+' '+Math.abs(MKT.tc).toFixed(1)+'%';$('priceChange').className='price-change '+(MKT.tc>=0?'up':'down');
    $('pBtc').innerHTML='BTC <b>$'+MKT.bp.toLocaleString()+'</b>';$('pEth').innerHTML='ETH <b>$'+MKT.ep.toLocaleString()+'</b>';
  }
  // Quick prompts
  var prompts=["What's TON at?","Is TON a good buy?","Best staking yields","Check my wallet","DeFi opportunities on TON","Help me build an agent"];
  $('quickPrompts').innerHTML=prompts.map(function(p){return '<div class="qp" onclick="askQuick(this.textContent)">'+p+'</div>';}).join('');
  // My agents
  var h='';
  if(agents.length){
    h+='<div class="sec"><div class="sec-t">Your Agents</div><div class="sec-a">'+agents.length+'</div></div>';
    agents.forEach(function(ag,i){
      h+='<div class="agent-card afu" style="animation-delay:'+(0.03+i*0.03)+'s" onclick="openChat(agents['+i+'])">';
      h+='<div class="agent-card-top" style="background:'+(ag.color||'var(--b)')+'"></div><div class="agent-row">';
      h+='<div class="agent-av" style="background:'+(ag.color||'var(--b)')+'15">'+ag.icon+'</div>';
      h+='<div class="agent-body"><div class="agent-name">'+ag.name+'</div><div class="agent-desc">'+ag.desc+'</div>';
      h+='<div class="agent-meta"><span class="agent-pill" style="color:var(--b);background:rgba(99,179,237,.07)">'+(ag.queries||0)+' queries</span>';
      h+='<span class="agent-pill" style="color:var(--o);background:rgba(251,191,36,.07)">'+ag.price+' TON</span></div></div>';
      h+='<span style="font-size:12px;color:var(--t3);cursor:pointer;padding:8px" onclick="event.stopPropagation();shareAgent('+i+')">üì§</span>';
      h+='</div></div>';
    });
  }
  $('homeAgents').innerHTML=h;
}

// ‚ïê‚ïê‚ïê RENDER: CREATE ‚ïê‚ïê‚ïê
function renderCreate(){
  var h='<div class="create-hero"><h2>Create an Agent</h2><p>Start from a template or build from scratch</p></div>';
  h+='<div class="tmpl-grid">';
  TEMPLATES.forEach(function(t,i){
    h+='<div class="tmpl afu" style="animation-delay:'+(0.05+i*0.04)+'s;border-top:2px solid '+(t.color||'var(--g)')+'" onclick="deployTemplate('+i+')">';
    h+='<div class="tmpl-ic">'+t.icon+'</div><div class="tmpl-nm">'+t.name+'</div><div class="tmpl-ds">'+t.desc+'</div></div>';
  });
  h+='<div class="tmpl afu" style="animation-delay:.25s;border-top:2px solid var(--g)" onclick="openChat(AGNT);setTimeout(function(){$(\'cpIn\').value=\'I want to create a custom agent\';send();},200);">';
  h+='<div class="tmpl-ic">üí¨</div><div class="tmpl-nm">With AI</div><div class="tmpl-ds">Chat with AGNT to design your agent</div></div>';
  h+='<div class="tmpl afu" style="animation-delay:.28s;border-top:2px solid var(--t3)" onclick="showManual()">';
  h+='<div class="tmpl-ic">üõ†Ô∏è</div><div class="tmpl-nm">Manual</div><div class="tmpl-ds">Define prompt, tools, and settings</div></div>';
  h+='</div>';
  if(agents.length){
    h+='<div class="sec" style="margin-top:16px"><div class="sec-t">Your Agents</div></div>';
    agents.forEach(function(ag,i){
      h+='<div class="agent-card" style="margin:0 16px 8px" onclick="openChat(agents['+i+'])"><div class="agent-row"><div class="agent-av" style="background:'+(ag.color||'var(--b)')+'15;width:36px;height:36px;font-size:18px;border-radius:10px">'+ag.icon+'</div><div class="agent-body"><div class="agent-name" style="font-size:13px">'+ag.name+'</div><div class="agent-desc">'+ag.desc+'</div></div><span style="font-size:10px;color:var(--t3);padding:8px" onclick="event.stopPropagation();shareAgent('+i+')">üì§</span></div></div>';
    });
  }
  $('pg1').innerHTML=h;
}

function deployTemplate(idx){
  var t=TEMPLATES[idx];
  var ag={id:'ag_'+Date.now(),name:t.name,icon:t.icon,color:t.color||'#63b3ed',desc:t.desc,prompt:t.prompt,tools:t.tools,price:t.price,queries:0};
  agents.push(ag);save();
  toast('üöÄ '+ag.name+' deployed!');haptic('medium');
  renderCreate();renderHome();
}

function showManual(){
  $('modalBg').classList.add('on');
  var h='<h3>Create Agent</h3><p style="font-size:11px;color:var(--t3);margin-bottom:16px">Define your agent manually</p>';
  h+='<div class="form-group"><label>Name</label><input class="fi" id="mName" placeholder="Whale Watcher"></div>';
  h+='<div class="form-group"><label>Icon (emoji)</label><input class="fi" id="mIcon" placeholder="üêã"></div>';
  h+='<div class="form-group"><label>Description</label><input class="fi" id="mDesc" placeholder="What it does"></div>';
  h+='<div class="form-group"><label>System Prompt</label><textarea class="fi fi-area" id="mPrompt" placeholder="You are a..."></textarea></div>';
  h+='<div class="form-group"><label>Tools</label></div>';
  h+='<div class="tool-toggle"><div class="tt on" id="mtP" onclick="this.classList.toggle(\'on\')">üìà Prices</div><div class="tt" id="mtW" onclick="this.classList.toggle(\'on\')">üí≥ Wallet</div><div class="tt" id="mtT" onclick="this.classList.toggle(\'on\')">‚õìÔ∏è Chain</div></div>';
  h+='<div class="form-group"><label>Price per query (TON)</label><input class="fi" id="mPrice" placeholder="0.01" type="number" step="0.01"></div>';
  h+='<div style="padding:0 16px"><button class="btn btn-g" onclick="deployManual()">Deploy Agent</button></div>';
  $('modal').innerHTML=h;
}

function deployManual(){
  var name=$('mName').value.trim();var prompt=$('mPrompt').value.trim();
  if(!name||!prompt){toast('Name and prompt required',true);return;}
  var ag={id:'ag_'+Date.now(),name:name,icon:$('mIcon').value.trim()||'ü§ñ',color:'#63b3ed',desc:$('mDesc').value.trim()||name,prompt:prompt,tools:{prices:$('mtP').classList.contains('on'),wallet:$('mtW').classList.contains('on'),tonapi:$('mtT').classList.contains('on')},price:parseFloat($('mPrice').value)||0.01,queries:0};
  agents.push(ag);save();closeModal();
  toast('üöÄ '+ag.name+' deployed!');haptic('medium');
  renderCreate();renderHome();
}
function closeModal(){$('modalBg').classList.remove('on');}

// ‚ïê‚ïê‚ïê RENDER: AGENTS ‚ïê‚ïê‚ïê
function renderAgents(){
  var h='<div class="sec"><div class="sec-t">All Agents</div></div>';
  h+='<div class="agent-card" onclick="openChat(AGNT)"><div class="agent-card-top" style="background:var(--g)"></div><div class="agent-row"><div class="agent-av" style="background:var(--gg)">ü§ñ</div><div class="agent-body"><div class="agent-name">AGNT <span style="font-size:9px;background:var(--gd);color:var(--g);padding:2px 6px;border-radius:4px">CORE ¬∑ FREE</span></div><div class="agent-desc">'+AGNT.desc+'</div><div class="agent-meta"><span class="agent-pill" style="color:var(--g);background:var(--gd)">üìà üí≥ ‚õìÔ∏è All tools</span></div></div></div></div>';
  if(!agents.length)h+='<div style="text-align:center;padding:32px 20px;color:var(--t3)"><div style="font-size:32px;margin-bottom:8px">‚ú®</div><div style="font-size:13px;font-weight:600">No agents yet</div><div style="font-size:11px;margin-top:4px">Go to Create to build your first agent</div></div>';
  agents.forEach(function(ag,i){
    h+='<div class="agent-card afu" style="animation-delay:'+(0.03+i*0.03)+'s" onclick="openChat(agents['+i+'])">';
    h+='<div class="agent-card-top" style="background:'+(ag.color||'var(--b)')+'"></div><div class="agent-row">';
    h+='<div class="agent-av" style="background:'+(ag.color||'var(--b)')+'15">'+ag.icon+'</div>';
    h+='<div class="agent-body"><div class="agent-name">'+ag.name+'</div><div class="agent-desc">'+ag.desc+'</div>';
    var pills=[];if(ag.tools.prices)pills.push('üìà');if(ag.tools.wallet)pills.push('üí≥');if(ag.tools.tonapi)pills.push('‚õìÔ∏è');
    h+='<div class="agent-meta"><span class="agent-pill" style="color:var(--b);background:rgba(99,179,237,.07)">'+pills.join(' ')+'</span><span class="agent-pill" style="color:var(--o);background:rgba(251,191,36,.07)">'+ag.price+' TON</span></div></div>';
    h+='<span style="font-size:12px;color:var(--t3);cursor:pointer;padding:8px" onclick="event.stopPropagation();shareAgent('+i+')">üì§</span></div></div>';
  });
  $('pg2').innerHTML=h;
}

// ‚ïê‚ïê‚ïê RENDER: PROFILE ‚ïê‚ïê‚ïê
function renderProfile(){
  var h='<div class="profile"><div class="profile-av">'+((W.addr?W.addr.slice(-2):'?').toUpperCase())+'</div>';
  h+='<div class="profile-name">'+(W.addr?W.addr.slice(0,6)+'...'+W.addr.slice(-4):'Not Connected')+'</div>';
  if(W.addr)h+='<div class="profile-addr" onclick="navigator.clipboard.writeText(\''+W.addr+'\');toast(\'Copied!\');">Tap to copy address</div>';
  h+='</div>';
  h+='<div class="profile-stats">';
  h+='<div class="ps"><div class="ps-v" style="color:var(--g)">'+(W.bal?W.bal.toFixed(1):'‚Äî')+'</div><div class="ps-l">TON Balance</div></div>';
  h+='<div class="ps"><div class="ps-v" style="color:var(--p)">'+agents.length+'</div><div class="ps-l">Agents</div></div>';
  var totalQ=0;agents.forEach(function(a){totalQ+=(a.queries||0);});
  h+='<div class="ps"><div class="ps-v" style="color:var(--b)">'+totalQ+'</div><div class="ps-l">Queries</div></div>';
  h+='</div>';
  if(!W.addr)h+='<div style="padding:16px"><button class="btn btn-g" onclick="handleWallet()">Connect Wallet</button></div>';
  else h+='<div style="padding:16px"><button class="btn btn-s" onclick="if(confirm(\'Disconnect wallet?\')){if(W.ui)W.ui.disconnect();}">Disconnect Wallet</button></div>';
  h+='<div style="padding:0 16px"><button class="btn btn-s" onclick="if(confirm(\'Clear all local data?\')){localStorage.clear();location.reload();}">Reset All Data</button></div>';
  $('pg3').innerHTML=h;
}

// ‚ïê‚ïê‚ïê IMPORT AGENT FROM DEEPLINK ‚ïê‚ïê‚ïê
function checkImport(){
  try{
    var tg=window.Telegram?.WebApp;
    var param=tg?.initDataUnsafe?.start_param||new URLSearchParams(location.search).get('startapp');
    if(!param||param.length<10)return;
    var data=JSON.parse(decodeURIComponent(escape(atob(param))));
    if(data.n&&data.p){
      var ag={id:'ag_'+Date.now(),name:data.n,icon:data.i||'ü§ñ',desc:data.d||'',prompt:data.p,tools:data.t||{prices:true},price:data.pr||0.01,queries:0};
      agents.push(ag);save();
      toast('ü§ñ Imported: '+ag.name);
    }
  }catch(e){}
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
load();
checkImport();
initWallet();
renderHome();
fetchPrices().then(function(){renderHome();});
setInterval(function(){fetchPrices().then(function(){if(tab===0)renderHome();});},30000);

// Save on visibility change
document.addEventListener('visibilitychange',function(){if(document.hidden)save();});

// Telegram WebApp integration
try{
  var tg=window.Telegram?.WebApp;
  if(tg){tg.ready();tg.expand();tg.enableClosingConfirmation();}
}catch(e){}
</script>
</body>
</html>
